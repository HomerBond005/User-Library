<?php
 require_once "class.databaseconnection.php"; require_once "class.user.php"; require_once "settings.php"; class Group { protected $created = false; protected $id; protected $deleted = false; protected $dbCache; public function __construct() { $this->dbCache = new Cache(); } public function openWithId($groupId) { if ($this->created) throw new Exception("There is already a group assigned"); $returnValue = false; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `id` FROM `{dbpre}groups` WHERE `id`=?"); $stmt->bind_param("i", $groupId); $stmt->execute(); $stmt->store_result(); if ($stmt->num_rows > 0) { $this->id = $groupId; $this->created = true; $returnValue = true; } $stmt->close(); return $returnValue; } public function getId() { return $this->id; } public function hasPermission($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if ($this->dbCache->inCache("haspermission_$name")) return $this->dbCache->getField("haspermission_$name"); $permissionId = $this->convertPermissionTitleToId($name); if ($permissionId === null) return false; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `id` FROM `{dbpre}group_permissions` WHERE `groupid`=? AND `permissionid`=? LIMIT 1"); $stmt->bind_param("ii", $this->id, $permissionId); $stmt->execute(); $stmt->bind_result($mappingId); if ($stmt->fetch()) $hasPermission = true; else $hasPermission = false; $stmt->close(); $this->dbCache->setField("haspermission_$name", $hasPermission); return $hasPermission; } public function addPermission($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if ($this->hasPermission($name)) return false; $permissionId = $this->convertPermissionTitleToId($name); if ($permissionId === null) return false; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("INSERT INTO `{dbpre}group_permissions` (`groupid`, `permissionid`) VALUES (?, ?)"); $stmt->bind_param("ii", $this->id, $permissionId); $stmt->execute(); $stmt->close(); $this->dbCache->setField("haspermission_$name", true); return true; } public function removePermission($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if (! $this->hasPermission($name)) return false; $permissionId = $this->convertPermissionTitleToId($name); if ($permissionId === null) return false; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("DELETE FROM `{dbpre}group_permissions` WHERE `groupid`=? AND `permissionid`=? LIMIT 1"); $stmt->bind_param("ii", $this->id, $permissionId); $stmt->execute(); $stmt->close(); $this->dbCache->setField("haspermission_$name", false); return true; } public function getName() { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if ($this->dbCache->inCache("name")) return $this->dbCache->getField("name"); $dbCon = DatabaseConnection::getDatabaseConnection(); $returnValue; $stmt = $dbCon->prepare("SELECT `name` FROM `{dbpre}groups` WHERE `id`=?"); $stmt->bind_param("i", $this->id); $stmt->execute(); $stmt->bind_result($name); if ($stmt->fetch()) $returnValue = $name; else $returnValue = false; $stmt->close(); $this->dbCache->setField("name", $returnValue); return $returnValue; } public function setName($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("UPDATE `{dbpre}groups` SET `name`=? WHERE `id`=?"); $stmt->bind_param("si", $name, $this->id); $stmt->execute(); $stmt->close(); $this->dbCache->setField("name", $name); } public function getAllUsersInGroup($limit=null, $skip=null) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); $limitCommand = ""; if (is_int($limit)) $limitCommand = is_int($skip)? " LIMIT $skip, $limit" : " LIMIT $limit"; elseif (is_int($skip)) throw new Exception("Cannot skip without limiting"); $users = array(); $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `userid` FROM `{dbpre}user_groups` WHERE `groupid`=?$limitCommand"); $stmt->bind_param("i", $this->id); $stmt->execute(); $stmt->bind_result($userId); while ($stmt->fetch()) { $user = new User(); $user->openWithId($userId); $users[] = $user; } $stmt->close(); return $users; } public function deleteGroup() { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); $dbCon = DatabaseConnection::getDatabaseConnection(); $delGroupStmt = $dbCon->prepare("DELETE FROM `{dbpre}groups` WHERE `id`=? LIMIT 1"); $delGroupStmt->bind_param("i", $this->id); $delGroupStmt->execute(); $delGroupStmt->close(); $delUserConnectionsStmt = $dbCon->prepare("DELETE FROM `{dbpre}user_groups` WHERE `groupid`=? LIMIT 1"); $delUserConnectionsStmt->bind_param("i", $this->id); $delUserConnectionsStmt->execute(); $delUserConnectionsStmt->close(); $delPermissionConnectionsStmt = $dbCon->prepare("DELETE FROM `{dbpre}group_permissions` WHERE `groupid`=? LIMIT 1"); $delPermissionConnectionsStmt->bind_param("i", $this->id); $delPermissionConnectionsStmt->execute(); $delPermissionConnectionsStmt->close(); $this->deleted = true; return true; } public static function create($groupname, &$groupId="unset") { $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("INSERT INTO `{dbpre}groups` (`name`) VALUES (?)"); $stmt->bind_param("s", $groupname); $stmt->execute(); $groupId = $dbCon->insert_id(); $stmt->close(); } public static function getAllGroups($limit=null, $skip=null) { $limitCommand = ""; $groupIds = array(); if (is_int($limit)) $limitCommand = is_int($skip)? " LIMIT $skip, $limit" : " LIMIT $limit"; elseif (is_int($skip)) throw new Exception("Cannot skip without limiting"); $groups = array(); $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `id` FROM `{dbpre}groups`"); $stmt->execute(); $stmt->bind_result($groupId); while ($stmt->fetch()) $groupIds[] = $groupId; $stmt->close(); foreach ($groupIds as $groupId) { $group = new Group(); $group->openWithId($groupId); $groups[] = $group; } return $groups; } public function addCustomField($name, $type) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("ALTER TABLE `{dbpre}groups` ADD `custom_$name` $type"); $stmt->execute(); $stmt->close(); } public function removeCustomField($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("ALTER TABLE `{dbpre}groups` DROP `custom_$name`"); $stmt->execute(); $stmt->close(); } public function saveCustomField($name, $value) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if (is_integer($value)) $typeAbb ='i'; elseif (is_double($value)) $typeAbb = 'd'; elseif (is_string($value)) $typeAbb = 's'; else $typeAbb = 'b'; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("UPDATE `{dbpre}groups` SET `custom_$name`=? WHERE `id`=?"); $stmt->bind_param($typeAbb . "i", $value, $this->id); $stmt->execute(); $stmt->close(); $this->dbCache->setField("custom_$name", $value); return true; } public function getCustomField($name) { if (! $this->created || $this->deleted) throw new Exception("There is no group assigned"); if ($this->dbCache->inCache("custom_$name")) return $this->dbCache->getField("custom_$name"); $returnValue = false; $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `custom_$name` FROM `{dbpre}groups` WHERE `id`=?"); $stmt->bind_param("i", $this->id); $stmt->execute(); $stmt->bind_result($result); if ($stmt->fetch()) $returnValue = $result; else $returnValue = false; $stmt->close(); $this->dbCache->setField("custom_$name", $returnValue); return $returnValue; } private function convertPermissionTitleToId($title) { $dbCon = DatabaseConnection::getDatabaseConnection(); $stmt = $dbCon->prepare("SELECT `id` FROM `{dbpre}permissions` WHERE `name`=? LIMIT 1"); $stmt->bind_param("s", $title); $stmt->execute(); $stmt->bind_result($id); if ($stmt->fetch()) { $stmt->close(); return $id; } else { $stmt->close(); $insertStmt = $dbCon->prepare("INSERT INTO `{dbpre}permissions` (`name`) VALUES (?)"); $insertStmt->bind_param("s", $title); $insertStmt->execute(); $id = $dbCon->insert_id(); $insertStmt->close(); return $id; } } } ?>